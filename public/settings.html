<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCC-MO | ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</title>
    <meta name="description" content="‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--color-bg-muted);
            border-radius: var(--radius-md);
        }

        .info-label {
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }

        .info-value {
            font-family: var(--font-display);
            font-weight: 600;
            color: var(--color-text);
        }

        .action-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: var(--space-xl);
        }

        .action-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .action-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }

        .action-desc {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: var(--space-lg);
        }
    </style>
</head>

<body>
    <!-- Background Pattern -->
    <div class="bg-pattern">
        <div class="floating-shape floating-shape-1"></div>
        <div class="floating-shape floating-shape-2"></div>
        <div class="floating-shape floating-shape-3"></div>
    </div>

    <div class="app-layout">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="menu-toggle" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>
        <div class="mobile-overlay" id="mobile-overlay"></div>
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-logo">PCC</div>
                <div class="brand-text">
                    <h1>PCC-MO</h1>
                    <p>Concrete Monitor</p>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="/" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/orders" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                </a>
                <a href="/analytics" class="nav-item">
                    <span class="nav-icon">üìà</span>
                    <span>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                </a>
                <a href="/compare" class="nav-item">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>
                </a>
                <a href="/settings" class="nav-item active">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </a>
            </nav>

            <div class="nav-footer">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>Live Dashboard</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1 class="page-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h1>
                    <p class="page-subtitle">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </header>

            <!-- Actions Grid -->
            <section class="settings-grid mb-lg">
                <!-- Sync to Sheets -->
                <div class="card action-card">
                    <div class="action-icon">üì§</div>
                    <h3 class="action-title">Sync to Google Sheets</h3>
                    <p class="action-desc">
                        ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Sync ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets
                    </p>
                    <button class="btn btn-primary btn-lg" onclick="settings.syncToSheets()" id="sync-btn">
                        Sync Now
                    </button>
                </div>

                <!-- Initialize Sheets -->
                <div class="card action-card">
                    <div class="action-icon">üìã</div>
                    <h3 class="action-title">‡∏™‡∏£‡πâ‡∏≤‡∏á Header Row</h3>
                    <p class="action-desc">
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô Google Sheets (‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï)
                    </p>
                    <button class="btn btn-secondary btn-lg" onclick="settings.initSheets()">
                        Initialize Headers
                    </button>
                </div>
            </section>

            <!-- System Info -->
            <section class="settings-grid">
                <!-- System Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üñ•Ô∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <button class="btn btn-ghost btn-sm" onclick="settings.loadHealth()">üîÑ</button>
                    </div>
                    <div class="info-list" id="system-info">
                        <div class="info-item">
                            <span class="info-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                            <span class="info-value" id="sys-status">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Database</span>
                            <span class="info-value" id="sys-db">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span class="info-value" id="sys-orders">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Google Sheets</span>
                            <span class="info-value" id="sys-sheets">-</span>
                        </div>
                    </div>
                </div>

                <!-- Sync Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sync</h3>
                    </div>
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Sync ‡πÅ‡∏•‡πâ‡∏ß</span>
                            <span class="info-value text-success" id="sync-count">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">‡∏£‡∏≠ Sync</span>
                            <span class="info-value text-warning" id="pending-count">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤ Sync</span>
                            <span class="info-value" id="sync-rate">-</span>
                        </div>
                    </div>
                </div>

                <!-- About -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚ÑπÔ∏è ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</h3>
                    </div>
                    <div class="info-list">
                        <div class="info-item">
                            <span class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö</span>
                            <span class="info-value">PCC-MO</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô</span>
                            <span class="info-value">1.0.0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Framework</span>
                            <span class="info-value">Express.js + sql.js</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</span>
                            <span class="info-value">LINE Bot ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="/js/main.js"></script>
    <script>
        const settings = {
            async init() {
                await this.loadHealth();
                await this.loadSyncStatus();
            },

            async loadHealth() {
                try {
                    const data = await PCCMO.fetchAPI('/health');

                    PCCMO.setText('sys-status', data.status === 'healthy' ? '‚úì ‡∏õ‡∏Å‡∏ï‡∏¥' : '‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤');
                    PCCMO.setText('sys-db', data.database?.connected ? '‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß' : '‚úó ‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
                    PCCMO.setText('sys-orders', PCCMO.formatNumber(data.database?.totalOrders || 0));
                    PCCMO.setText('sys-sheets', data.googleSheets?.connected ? '‚úì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
                } catch (error) {
                    console.error('Health check error:', error);
                    PCCMO.setText('sys-status', '‚úó ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ');
                }
            },

            async loadSyncStatus() {
                try {
                    const data = await PCCMO.fetchAnalytics({});
                    const syncStatus = data.syncStatus || [];

                    const synced = syncStatus.find(s => Number(s.status) === 1)?.count || 0;
                    const pending = syncStatus.find(s => Number(s.status) === 0)?.count || 0;
                    const total = synced + pending;
                    const rate = total > 0 ? Math.round((synced / total) * 100) : 0;

                    PCCMO.setText('sync-count', PCCMO.formatNumber(synced));
                    PCCMO.setText('pending-count', PCCMO.formatNumber(pending));
                    PCCMO.setText('sync-rate', `${rate}%`);
                } catch (error) {
                    console.error('Sync status error:', error);
                }
            },

            async syncToSheets() {
                const btn = document.getElementById('sync-btn');
                if (btn) btn.disabled = true;

                try {
                    PCCMO.showToast('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync ‡πÑ‡∏õ Google Sheets...', 'info');
                    const result = await PCCMO.syncToSheets();

                    if (result.error) {
                        PCCMO.showToast(`‚ùå ${result.error}`, 'error');
                    } else if (result.synced > 0) {
                        PCCMO.showToast(`‚úÖ Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.synced} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                        await this.loadSyncStatus();
                    } else {
                        PCCMO.showToast('‚úì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Sync', 'success');
                    }
                } catch (error) {
                    PCCMO.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync', 'error');
                } finally {
                    if (btn) btn.disabled = false;
                }
            },

            async initSheets() {
                try {
                    PCCMO.showToast('üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Header Row...', 'info');
                    const result = await PCCMO.fetchAPI('/api/sheets/init', { method: 'POST' });

                    if (result.error) {
                        PCCMO.showToast(`‚ùå ${result.error}`, 'error');
                    } else {
                        PCCMO.showToast('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Header Row ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    }
                } catch (error) {
                    PCCMO.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => settings.init());
    </script>
</body>

</html>