<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCC-MO | ‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</title>
    <meta name="description" content="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <!-- Background Pattern -->
    <div class="bg-pattern">
        <div class="floating-shape floating-shape-1"></div>
        <div class="floating-shape floating-shape-2"></div>
        <div class="floating-shape floating-shape-3"></div>
    </div>

    <div class="app-layout">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="menu-toggle" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>
        <div class="mobile-overlay" id="mobile-overlay"></div>
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-logo">PCC</div>
                <div class="brand-text">
                    <h1>PCC-MO</h1>
                    <p>Concrete Monitor</p>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="/" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/orders" class="nav-item active">
                    <span class="nav-icon">üìã</span>
                    <span>‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</span>
                </a>
                <a href="/analytics" class="nav-item">
                    <span class="nav-icon">üìà</span>
                    <span>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                </a>
                <a href="/compare" class="nav-item">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </a>
            </nav>

            <div class="nav-footer">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>Live Dashboard</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1 class="page-title">‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï</h1>
                    <p class="page-subtitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="orders.resetFilters()">
                        üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                    <button class="btn btn-primary" onclick="orders.syncToSheets()">
                        üì§ Sync to Sheets
                    </button>
                </div>
            </header>

            <!-- Filter Panel -->
            <section class="filter-panel">
                <div class="filter-grid">
                    <!-- Date Range -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div class="range-group">
                            <input type="date" id="filter-start" class="form-input">
                            <span class="range-sep">‚Üí</span>
                            <input type="date" id="filter-end" class="form-input">
                        </div>
                        <div class="quick-dates">
                            <button class="quick-date-btn" data-range="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="7d">7 ‡∏ß‡∏±‡∏ô</button>
                            <button class="quick-date-btn" data-range="30d">30 ‡∏ß‡∏±‡∏ô</button>
                            <button class="quick-date-btn" data-range="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="quarter">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
                        </div>
                    </div>

                    <!-- Sync Status -->
                    <div class="form-group">
                        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sync</label>
                        <select id="filter-sync" class="form-select">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="1">‚úì Synced</option>
                            <option value="0">‚óã Pending</option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div class="form-group">
                        <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                        <input type="search" id="filter-search" class="form-input"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
                    </div>
                </div>

                <!-- Chip Filters Row -->
                <div class="filter-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</label>
                        <div class="chip-group" id="factory-chips"></div>
                    </div>
                </div>

                <div class="filter-row" style="border-top: none; padding-top: 0; margin-top: 0;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <div class="chip-group" id="product-chips"></div>
                    </div>
                </div>

                <div class="filter-row" style="border-top: none; padding-top: 0; margin-top: 0;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</label>
                        <div class="chip-group" id="supervisor-chips"></div>
                    </div>
                </div>

                <!-- Numeric Range Filters -->
                <div class="filter-row">
                    <div class="form-group">
                        <label class="form-label">‡∏õ‡∏π‡∏ô (‡∏Ñ‡∏¥‡∏ß)</label>
                        <div class="range-group">
                            <input type="number" id="cement-min" class="form-input" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                            <span class="range-sep">‚Äì</span>
                            <input type="number" id="cement-max" class="form-input" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏õ‡∏π‡∏ô‡πÇ‡∏´‡∏•‡∏î (‡∏Ñ‡∏¥‡∏ß)</label>
                        <div class="range-group">
                            <input type="number" id="loaded-min" class="form-input" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                            <span class="range-sep">‚Äì</span>
                            <input type="number" id="loaded-max" class="form-input" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡∏¥‡∏ß)</label>
                        <div class="range-group">
                            <input type="number" id="diff-min" class="form-input" placeholder="‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥">
                            <span class="range-sep">‚Äì</span>
                            <input type="number" id="diff-max" class="form-input" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î">
                        </div>
                    </div>
                </div>

                <!-- Filter Actions -->
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="orders.applyFilters()">
                        üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                    <button class="btn btn-secondary" onclick="orders.resetFilters()">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <span class="text-muted" style="margin-left: auto;" id="filter-summary">
                        ‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </span>
                </div>
            </section>

            <!-- Orders Table -->
            <section class="card">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</th>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                <th>‡∏õ‡∏π‡∏ô (‡∏Ñ‡∏¥‡∏ß)</th>
                                <th>‡πÇ‡∏´‡∏•‡∏î</th>
                                <th>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr>
                                <td colspan="10" class="text-center text-muted" style="padding: 2rem;">
                                    <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination">
                    <button class="page-btn" id="prev-btn" onclick="orders.prevPage()" disabled>
                        ‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    </button>
                    <span class="page-info" id="page-info">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
                    <button class="page-btn" id="next-btn" onclick="orders.nextPage()">
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="/js/main.js"></script>
    <script>
        const orders = {
            currentPage: 1,
            pageSize: 20,
            totalOrders: 0,
            filters: {},

            async init() {
                this.setDefaultFilters();
                this.initQuickDates();
                await this.loadFilterOptions();
                await this.loadOrders();
            },

            setDefaultFilters() {
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);

                PCCMO.setInputValue('filter-start', PCCMO.toISODate(start));
                PCCMO.setInputValue('filter-end', PCCMO.toISODate(today));
            },

            initQuickDates() {
                document.querySelectorAll('.quick-date-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const range = PCCMO.getDateRangePreset(btn.dataset.range);
                        PCCMO.setInputValue('filter-start', range.start);
                        PCCMO.setInputValue('filter-end', range.end);
                    });
                });
            },

            async loadFilterOptions() {
                try {
                    const options = await PCCMO.fetchFilterOptions();
                    PCCMO.renderChipGroup('factory-chips', options.factories, v => `‡πÇ‡∏£‡∏á ${v}`);
                    PCCMO.renderChipGroup('product-chips', options.products, v => v);
                    PCCMO.renderChipGroup('supervisor-chips', options.supervisors, v => v);
                } catch (error) {
                    console.error('Filter options error:', error);
                }
            },

            getFiltersFromForm() {
                return {
                    startDate: PCCMO.getInputValue('filter-start'),
                    endDate: PCCMO.getInputValue('filter-end'),
                    syncStatus: PCCMO.getInputValue('filter-sync'),
                    search: PCCMO.getInputValue('filter-search'),
                    factoryIds: PCCMO.getSelectedChips('factory-chips'),
                    productCodes: PCCMO.getSelectedChips('product-chips'),
                    supervisors: PCCMO.getSelectedChips('supervisor-chips'),
                    minCement: PCCMO.getInputValue('cement-min'),
                    maxCement: PCCMO.getInputValue('cement-max'),
                    minLoaded: PCCMO.getInputValue('loaded-min'),
                    maxLoaded: PCCMO.getInputValue('loaded-max'),
                    minDifference: PCCMO.getInputValue('diff-min'),
                    maxDifference: PCCMO.getInputValue('diff-max')
                };
            },

            applyFilters() {
                this.filters = this.getFiltersFromForm();
                this.currentPage = 1;
                this.loadOrders();
            },

            async loadOrders() {
                const tbody = document.getElementById('orders-tbody');
                tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center text-muted" style="padding: 2rem;">
              <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
            </td>
          </tr>
        `;

                try {
                    const offset = (this.currentPage - 1) * this.pageSize;
                    const data = await PCCMO.fetchOrders(this.filters, this.pageSize, offset);

                    this.totalOrders = data.total || 0;
                    this.renderOrders(data.orders);
                    this.updatePagination();
                    this.updateFilterSummary();
                } catch (error) {
                    console.error('Load orders error:', error);
                    tbody.innerHTML = `
            <tr>
              <td colspan="10" class="text-center text-muted" style="padding: 2rem;">
                ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </td>
            </tr>
          `;
                }
            },

            renderOrders(ordersList) {
                const tbody = document.getElementById('orders-tbody');

                if (!ordersList || ordersList.length === 0) {
                    tbody.innerHTML = `
            <tr>
              <td colspan="10" class="text-center text-muted" style="padding: 2rem;">
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
              </td>
            </tr>
          `;
                    return;
                }

                tbody.innerHTML = ordersList.map(order => {
                    const cement = Number(order.cement_quantity);
                    const loaded = Number(order.loaded_quantity);
                    const diff = Number(order.difference);

                    return `
            <tr>
              <td><strong>#${order.id}</strong></td>
              <td>${PCCMO.formatDate(order.order_date)}</td>
              <td>üè≠ ‡πÇ‡∏£‡∏á ${order.factory_id || '-'}</td>
              <td>${PCCMO.escapeHtml(order.product_code || '-')}</td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${PCCMO.escapeHtml(order.product_detail || '')}">
                ${PCCMO.escapeHtml(order.product_detail || '-')}
              </td>
              <td class="font-semibold">${Number.isFinite(cement) ? cement.toFixed(2) : '-'}</td>
              <td>${Number.isFinite(loaded) ? loaded.toFixed(2) : '-'}</td>
              <td class="${diff > 0 ? 'text-success' : diff < 0 ? 'text-error' : ''}">${Number.isFinite(diff) ? diff.toFixed(2) : '-'}</td>
              <td>
                ${order.synced_to_sheets
                            ? '<span class="badge badge-success">‚úì Synced</span>'
                            : '<span class="badge badge-warning">‚óã Pending</span>'}
              </td>
              <td class="text-muted">${PCCMO.formatDateTime(order.created_at)}</td>
            </tr>
          `;
                }).join('');
            },

            updatePagination() {
                const totalPages = Math.ceil(this.totalOrders / this.pageSize) || 1;
                PCCMO.setText('page-info', `‡∏´‡∏ô‡πâ‡∏≤ ${this.currentPage} / ${totalPages}`);

                document.getElementById('prev-btn').disabled = this.currentPage <= 1;
                document.getElementById('next-btn').disabled = this.currentPage >= totalPages;
            },

            updateFilterSummary() {
                PCCMO.setText('filter-summary', `‡πÅ‡∏™‡∏î‡∏á ${PCCMO.formatNumber(this.totalOrders)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            },

            prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadOrders();
                }
            },

            nextPage() {
                const totalPages = Math.ceil(this.totalOrders / this.pageSize);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.loadOrders();
                }
            },

            resetFilters() {
                this.setDefaultFilters();
                PCCMO.setInputValue('filter-sync', '');
                PCCMO.setInputValue('filter-search', '');
                PCCMO.setInputValue('cement-min', '');
                PCCMO.setInputValue('cement-max', '');
                PCCMO.setInputValue('loaded-min', '');
                PCCMO.setInputValue('loaded-max', '');
                PCCMO.setInputValue('diff-min', '');
                PCCMO.setInputValue('diff-max', '');
                PCCMO.clearChipSelection('factory-chips');
                PCCMO.clearChipSelection('product-chips');
                PCCMO.clearChipSelection('supervisor-chips');
                this.applyFilters();
            },

            async syncToSheets() {
                try {
                    PCCMO.showToast('üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync ‡πÑ‡∏õ Google Sheets...', 'info');
                    const result = await PCCMO.syncToSheets();

                    if (result.error) {
                        PCCMO.showToast(`‚ùå ${result.error}`, 'error');
                    } else if (result.synced > 0) {
                        PCCMO.showToast(`‚úÖ Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${result.synced} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
                        await this.loadOrders();
                    } else {
                        PCCMO.showToast('‚úì ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Sync', 'success');
                    }
                } catch (error) {
                    PCCMO.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync', 'error');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => orders.init());
    </script>
</body>

</html>