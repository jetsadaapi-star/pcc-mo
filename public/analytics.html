<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCC-MO | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</title>
    <meta name="description" content="‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <!-- Background Pattern -->
    <div class="bg-pattern">
        <div class="floating-shape floating-shape-1"></div>
        <div class="floating-shape floating-shape-2"></div>
        <div class="floating-shape floating-shape-3"></div>
    </div>

    <div class="app-layout">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="menu-toggle" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>
        <div class="mobile-overlay" id="mobile-overlay"></div>
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-logo">PCC</div>
                <div class="brand-text">
                    <h1>PCC-MO</h1>
                    <p>Concrete Monitor</p>
                </div>
            </div>

            <nav class="nav-menu">
                <a href="/" class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/orders" class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
                </a>
                <a href="/analytics" class="nav-item active">
                    <span class="nav-icon">üìà</span>
                    <span>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                </a>
                <a href="/compare" class="nav-item">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    <span>‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</span>
                </a>
                <a href="/settings" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </a>
            </nav>

            <div class="nav-footer">
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span>Live Dashboard</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1 class="page-title">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h1>
                    <p class="page-subtitle">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="analytics.resetFilters()">
                        üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                    <button class="btn btn-primary" onclick="analytics.applyFilters()">
                        üîç ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                </div>
            </header>

            <!-- Filter Panel -->
            <section class="filter-panel">
                <div class="filter-grid">
                    <!-- Date Range -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div class="range-group">
                            <input type="date" id="filter-start" class="form-input">
                            <span class="range-sep">‚Üí</span>
                            <input type="date" id="filter-end" class="form-input">
                        </div>
                        <div class="quick-dates">
                            <button class="quick-date-btn" data-range="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="7d">7 ‡∏ß‡∏±‡∏ô</button>
                            <button class="quick-date-btn" data-range="30d">30 ‡∏ß‡∏±‡∏ô</button>
                            <button class="quick-date-btn" data-range="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="quarter">‡πÑ‡∏ï‡∏£‡∏°‡∏≤‡∏™‡∏ô‡∏µ‡πâ</button>
                            <button class="quick-date-btn" data-range="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
                        </div>
                    </div>

                    <!-- Period Grouping -->
                    <div class="form-group">
                        <label class="form-label">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏£‡∏≤‡∏ü</label>
                        <div class="chip-group" style="gap: 0.5rem;">
                            <label class="chip active" id="period-daily">
                                <input type="radio" name="period" value="daily" class="chip-checkbox" checked>
                                <span class="chip-label">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                            </label>
                            <label class="chip" id="period-monthly">
                                <input type="radio" name="period" value="monthly" class="chip-checkbox">
                                <span class="chip-label">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                            </label>
                        </div>
                    </div>

                    <!-- Sync Status -->
                    <div class="form-group">
                        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sync</label>
                        <select id="filter-sync" class="form-select">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="1">‚úì Synced</option>
                            <option value="0">‚óã Pending</option>
                        </select>
                    </div>
                </div>

                <!-- Factory Chips -->
                <div class="filter-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</label>
                        <div class="chip-group" id="factory-chips"></div>
                    </div>
                </div>

                <!-- Product Chips -->
                <div class="filter-row" style="border-top: none; padding-top: 0; margin-top: 0;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <div class="chip-group" id="product-chips"></div>
                    </div>
                </div>
            </section>

            <!-- Summary Cards -->
            <section class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon">üì¶</div>
                    <p class="kpi-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p>
                    <p class="kpi-value" id="stat-orders">-</p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üè≠</div>
                    <p class="kpi-label">‡∏õ‡∏π‡∏ô‡∏£‡∏ß‡∏°</p>
                    <p class="kpi-value" id="stat-cement">- <small>‡∏Ñ‡∏¥‡∏ß</small></p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üì§</div>
                    <p class="kpi-label">‡∏õ‡∏π‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏ß‡∏°</p>
                    <p class="kpi-value" id="stat-loaded">- <small>‡∏Ñ‡∏¥‡∏ß</small></p>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üìä</div>
                    <p class="kpi-label">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°</p>
                    <p class="kpi-value" id="stat-diff">- <small>‡∏Ñ‡∏¥‡∏ß</small></p>
                </div>
            </section>

            <!-- Charts Grid -->
            <section class="grid-2 mb-lg">
                <!-- Trend Chart -->
                <div class="card" style="grid-column: span 2;">
                    <div class="card-header">
                        <h3 class="card-title">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô</h3>
                        <span class="card-badge" id="trend-period-badge">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</span>
                    </div>
                    <div class="chart-canvas" id="trend-chart">
                        <div class="skeleton" style="height: 160px;"></div>
                    </div>
                </div>

                <!-- Sync Status -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sync</h3>
                    </div>
                    <div class="donut-chart" id="sync-chart">
                        <span class="donut-center" id="sync-percent">0%</span>
                    </div>
                    <div class="chart-legend" id="sync-legend">
                        <div class="legend-item">
                            <span class="legend-dot synced"></span>
                            <span>Synced: <strong id="sync-count">0</strong></span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot pending"></span>
                            <span>Pending: <strong id="pending-count">0</strong></span>
                        </div>
                    </div>
                </div>

                <!-- By Factory -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè≠ ‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô</h3>
                    </div>
                    <div id="factory-chart">
                        <div class="skeleton" style="height: 120px;"></div>
                    </div>
                </div>
            </section>

            <!-- More Charts -->
            <section class="grid-2">
                <!-- By Product -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì¶ ‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    </div>
                    <div id="product-chart">
                        <div class="skeleton" style="height: 120px;"></div>
                    </div>
                </div>

                <!-- By Supervisor -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üë∑ ‡πÉ‡∏ä‡πâ‡∏õ‡∏π‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h3>
                    </div>
                    <div id="supervisor-chart">
                        <div class="skeleton" style="height: 120px;"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="/js/main.js"></script>
    <script>
        const analytics = {
            period: 'daily',
            filters: {},

            async init() {
                this.setDefaultFilters();
                this.initQuickDates();
                this.initPeriodToggle();
                await this.loadFilterOptions();
                await this.loadAnalytics();
            },

            setDefaultFilters() {
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);

                PCCMO.setInputValue('filter-start', PCCMO.toISODate(start));
                PCCMO.setInputValue('filter-end', PCCMO.toISODate(today));
            },

            initQuickDates() {
                document.querySelectorAll('.quick-date-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const range = PCCMO.getDateRangePreset(btn.dataset.range);
                        PCCMO.setInputValue('filter-start', range.start);
                        PCCMO.setInputValue('filter-end', range.end);
                    });
                });
            },

            initPeriodToggle() {
                document.querySelectorAll('input[name="period"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.period = e.target.value;
                        document.getElementById('period-daily').classList.toggle('active', this.period === 'daily');
                        document.getElementById('period-monthly').classList.toggle('active', this.period === 'monthly');
                        PCCMO.setText('trend-period-badge', this.period === 'monthly' ? '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');
                    });
                });
            },

            async loadFilterOptions() {
                try {
                    const options = await PCCMO.fetchFilterOptions();
                    PCCMO.renderChipGroup('factory-chips', options.factories, v => `‡πÇ‡∏£‡∏á ${v}`);
                    PCCMO.renderChipGroup('product-chips', options.products, v => v);
                } catch (error) {
                    console.error('Filter options error:', error);
                }
            },

            getFiltersFromForm() {
                return {
                    startDate: PCCMO.getInputValue('filter-start'),
                    endDate: PCCMO.getInputValue('filter-end'),
                    syncStatus: PCCMO.getInputValue('filter-sync'),
                    factoryIds: PCCMO.getSelectedChips('factory-chips'),
                    productCodes: PCCMO.getSelectedChips('product-chips')
                };
            },

            applyFilters() {
                this.filters = this.getFiltersFromForm();
                this.loadAnalytics();
            },

            async loadAnalytics() {
                try {
                    const data = await PCCMO.fetchAnalytics(this.filters, this.period);
                    this.renderStats(data);
                    this.renderTrendChart(data.timeSeries);
                    this.renderSyncChart(data.syncStatus);
                    this.renderBarCharts(data);
                } catch (error) {
                    console.error('Analytics load error:', error);
                    PCCMO.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                }
            },

            renderStats(data) {
                const totals = data.totals || {};

                PCCMO.setText('stat-orders', PCCMO.formatNumber(totals.order_count || 0));

                document.getElementById('stat-cement').innerHTML =
                    `${PCCMO.formatDecimal(totals.total_cement || 0)} <small>‡∏Ñ‡∏¥‡∏ß</small>`;

                document.getElementById('stat-loaded').innerHTML =
                    `${PCCMO.formatDecimal(totals.total_loaded || 0)} <small>‡∏Ñ‡∏¥‡∏ß</small>`;

                document.getElementById('stat-diff').innerHTML =
                    `${PCCMO.formatDecimal(totals.total_difference || 0)} <small>‡∏Ñ‡∏¥‡∏ß</small>`;
            },

            renderTrendChart(timeSeries) {
                PCCMO.renderTrendChart('trend-chart', timeSeries, this.period);
            },

            renderSyncChart(syncStatus) {
                const synced = (syncStatus || []).find(s => Number(s.status) === 1)?.count || 0;
                const pending = (syncStatus || []).find(s => Number(s.status) === 0)?.count || 0;
                const total = synced + pending;
                const percent = total > 0 ? Math.round((synced / total) * 100) : 0;

                PCCMO.renderDonutChart('sync-chart', percent);
                PCCMO.setText('sync-percent', `${percent}%`);
                PCCMO.setText('sync-count', PCCMO.formatNumber(synced));
                PCCMO.setText('pending-count', PCCMO.formatNumber(pending));
            },

            renderBarCharts(data) {
                PCCMO.renderBarChart('factory-chart', data.byFactory, (key) => {
                    return key ? `‡πÇ‡∏£‡∏á ${key}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                });

                PCCMO.renderBarChart('product-chart', data.byProduct, (key) => {
                    return key || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™';
                });

                PCCMO.renderBarChart('supervisor-chart', data.bySupervisor, (key) => {
                    return key || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                });
            },

            resetFilters() {
                this.setDefaultFilters();
                this.period = 'daily';
                document.querySelector('input[name="period"][value="daily"]').checked = true;
                document.getElementById('period-daily').classList.add('active');
                document.getElementById('period-monthly').classList.remove('active');
                PCCMO.setText('trend-period-badge', '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô');

                PCCMO.setInputValue('filter-sync', '');
                PCCMO.clearChipSelection('factory-chips');
                PCCMO.clearChipSelection('product-chips');
                this.applyFilters();
            }
        };

        document.addEventListener('DOMContentLoaded', () => analytics.init());
    </script>
</body>

</html>